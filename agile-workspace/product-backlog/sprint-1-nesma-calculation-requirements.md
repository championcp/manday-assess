# Sprint 1: NESMA核心计算引擎需求规格书

## 📋 文档信息
- **文档类型：** 需求规格说明书 (Product Requirements Document)
- **Sprint版本：** Sprint 1 - 核心计算引擎
- **创建时间：** 2025-09-03
- **创建者：** Product Owner
- **项目名称：** 长沙市财政评审中心软件规模评估系统
- **质量等级：** 政府级项目 - 100%准确性要求

## 🎯 需求概述

### 业务背景
本需求规格基于《长沙市财政评审中心政府投资信息化项目评审指南》，为NESMA功能点评估系统提供核心计算引擎实现指导。系统必须严格遵循PDF指南中的计算公式和方法，确保与政府评审标准100%一致。

### 核心目标
1. **精确计算** - 实现NESMA五种功能点类型的精确计算
2. **标准合规** - 完全符合政府投资信息化项目评审指南
3. **可追溯性** - 所有计算过程可追溯、可审计
4. **零偏差要求** - 计算结果与PDF指南案例必须完全一致

## 📊 5种功能点元素计算规则定义

### 1. ILF (Internal Logic File - 内部逻辑文件)

#### 1.1 定义和识别标准
- **定义：** 系统内部维护的逻辑相关数据群
- **识别条件：**
  - 由应用系统内部维护的数据群
  - 通过EI(外部输入)进行修改
  - 包含用户可识别的逻辑相关数据

#### 1.2 复杂度判定规则
```
复杂度判定矩阵：
数据元素类型(DET) × 记录元素类型(RET)

        RET=1   RET=2-5   RET≥6
DET≤19   简单     简单     一般
DET20-50 简单     一般     复杂  
DET≥51   一般     复杂     复杂
```

#### 1.3 功能点权重
- **简单：** 7个功能点
- **一般：** 10个功能点  
- **复杂：** 15个功能点

#### 1.4 计算公式
```
ILF总功能点 = Σ(简单ILF数量 × 7) + Σ(一般ILF数量 × 10) + Σ(复杂ILF数量 × 15)
```

### 2. EIF (External Interface File - 外部接口文件)

#### 2.1 定义和识别标准
- **定义：** 被评估应用引用但由其他应用维护的逻辑相关数据群
- **识别条件：**
  - 由其他应用系统维护的数据群
  - 被当前系统用于参考目的
  - 不通过当前系统的EI进行修改

#### 2.2 复杂度判定规则
```
复杂度判定矩阵：
数据元素类型(DET) × 记录元素类型(RET)

        RET=1   RET=2-5   RET≥6
DET≤19   简单     简单     一般
DET20-50 简单     一般     复杂
DET≥51   一般     复杂     复杂
```

#### 2.3 功能点权重
- **简单：** 5个功能点
- **一般：** 7个功能点
- **复杂：** 10个功能点

#### 2.4 计算公式
```
EIF总功能点 = Σ(简单EIF数量 × 5) + Σ(一般EIF数量 × 7) + Σ(复杂EIF数量 × 10)
```

### 3. EI (External Input - 外部输入)

#### 3.1 定义和识别标准
- **定义：** 从外部边界输入应用的数据或控制信息
- **识别条件：**
  - 数据来自外部边界
  - 维护一个或多个ILF
  - 处理控制信息来维护应用行为

#### 3.2 复杂度判定规则
```
复杂度判定矩阵：
数据元素类型(DET) × 文件类型引用(FTR)

        FTR=1   FTR=2     FTR≥3
DET≤15   简单     简单     一般
DET16-19 简单     一般     复杂
DET≥20   一般     复杂     复杂
```

#### 3.3 功能点权重
- **简单：** 3个功能点
- **一般：** 4个功能点
- **复杂：** 6个功能点

#### 3.4 计算公式
```
EI总功能点 = Σ(简单EI数量 × 3) + Σ(一般EI数量 × 4) + Σ(复杂EI数量 × 6)
```

### 4. EO (External Output - 外部输出)

#### 4.1 定义和识别标准
- **定义：** 发送数据或控制信息到外部边界
- **识别条件：**
  - 数据发送到外部边界
  - 包含派生数据(计算、汇总等处理逻辑)
  - 维护应用行为

#### 4.2 复杂度判定规则
```
复杂度判定矩阵：
数据元素类型(DET) × 文件类型引用(FTR)

        FTR=1   FTR=2-3   FTR≥4
DET≤19   简单     简单     一般
DET20-25 简单     一般     复杂
DET≥26   一般     复杂     复杂
```

#### 4.3 功能点权重
- **简单：** 4个功能点
- **一般：** 5个功能点
- **复杂：** 7个功能点

#### 4.4 计算公式
```
EO总功能点 = Σ(简单EO数量 × 4) + Σ(一般EO数量 × 5) + Σ(复杂EO数量 × 7)
```

### 5. EQ (External Query - 外部查询)

#### 5.1 定义和识别标准
- **定义：** 发送数据到外部边界的输入输出组合
- **识别条件：**
  - 输入和输出组合
  - 检索数据或控制信息
  - 不包含派生数据
  - 不维护ILF，不改变应用行为

#### 5.2 复杂度判定规则
```
复杂度判定矩阵：
数据元素类型(DET) × 文件类型引用(FTR)

        FTR=1   FTR=2-3   FTR≥4
DET≤19   简单     简单     一般
DET20-25 简单     一般     复杂
DET≥26   一般     复杂     复杂
```

#### 5.3 功能点权重
- **简单：** 3个功能点
- **一般：** 4个功能点
- **复杂：** 6个功能点

#### 5.4 计算公式
```
EQ总功能点 = Σ(简单EQ数量 × 3) + Σ(一般EQ数量 × 4) + Σ(复杂EQ数量 × 6)
```

## 🔢 核心计算公式

### 未调整功能点(UFP)计算
```
UFP = ILF总功能点 + EIF总功能点 + EI总功能点 + EO总功能点 + EQ总功能点

标准简化公式 (基于PDF指南)：
UFP = 10 × ILF数量 + 7 × EIF数量 + 4 × EI数量 + 5 × EO数量 + 4 × EQ数量
```

### 调整功能点(AFP)计算
```
AFP = UFP × 调整因子(VAF)

其中调整因子(VAF) = 0.65 + 0.01 × Σ(影响度总和)
影响度评分范围：0-5分，14个影响因子
```

### 复用度调整计算
```
高复用度：实际功能点 = AFP × (1/3)
中复用度：实际功能点 = AFP × (2/3)  
低复用度：实际功能点 = AFP × 1
```

## 💻 技术实现要求

### 数据精度要求
- **BigDecimal精度：** 小数点后4位 (scale=4)
- **舍入模式：** RoundingMode.HALF_UP (四舍五入)
- **整数计算：** 使用BigDecimal避免浮点精度问题
- **中间计算：** 保持高精度，最终结果按需舍入

### 核心算法接口设计
```java
/**
 * NESMA核心计算引擎接口
 */
public interface NesmaCalculationEngine {
    
    /**
     * 计算未调整功能点(UFP)
     * @param functionPoints 功能点数据集合
     * @return UFP计算结果
     */
    BigDecimal calculateUFP(List<FunctionPoint> functionPoints);
    
    /**
     * 计算调整功能点(AFP)  
     * @param ufp 未调整功能点
     * @param adjustmentFactors 调整因子
     * @return AFP计算结果
     */
    BigDecimal calculateAFP(BigDecimal ufp, AdjustmentFactors adjustmentFactors);
    
    /**
     * 应用复用度调整
     * @param afp 调整功能点
     * @param reuseLevel 复用等级
     * @return 最终功能点
     */
    BigDecimal applyReuseAdjustment(BigDecimal afp, ReuseLevel reuseLevel);
}
```

### 数据模型要求
```java
/**
 * 功能点实体
 */
@Entity
public class FunctionPoint {
    @Column(precision = 19, scale = 4)
    private BigDecimal calculatedValue;
    
    @Enumerated(EnumType.STRING)
    private FunctionPointType type; // ILF, EIF, EI, EO, EQ
    
    @Enumerated(EnumType.STRING) 
    private ComplexityLevel complexity; // SIMPLE, AVERAGE, COMPLEX
    
    private Integer detCount; // 数据元素类型数量
    private Integer retCount; // 记录元素类型数量(ILF/EIF)
    private Integer ftrCount; // 文件类型引用数量(EI/EO/EQ)
}
```

## ✅ 验收标准和测试用例

### 主要验收标准
1. **计算精度验证**
   - 所有功能点计算结果与PDF指南案例100%一致
   - BigDecimal精度计算无误差
   - 复杂度判定逻辑完全正确

2. **边界条件测试**
   - DET/RET/FTR边界值判定准确
   - 复杂度等级划分正确
   - 极值情况处理稳定

3. **业务规则验证**
   - 功能点类型识别准确
   - 调整因子应用正确
   - 复用度计算准确

### 核心测试用例

#### 测试用例1：基础功能点计算
```
输入数据：
- ILF: 5个 (3个简单，2个一般)
- EIF: 3个 (2个简单，1个复杂) 
- EI: 8个 (5个简单，2个一般，1个复杂)
- EO: 6个 (4个简单，2个一般)
- EQ: 4个 (3个简单，1个一般)

预期结果：
UFP = (3×7 + 2×10) + (2×5 + 1×10) + (5×3 + 2×4 + 1×6) + (4×4 + 2×5) + (3×3 + 1×4)
    = (21 + 20) + (10 + 10) + (15 + 8 + 6) + (16 + 10) + (9 + 4)
    = 41 + 20 + 29 + 26 + 13 = 129
```

#### 测试用例2：复杂度判定边界测试
```
测试场景：ILF复杂度判定
- DET=19, RET=1 → 简单 (7点)
- DET=20, RET=1 → 简单 (7点)  
- DET=19, RET=2 → 简单 (7点)
- DET=20, RET=2 → 一般 (10点)
- DET=51, RET=1 → 一般 (10点)
- DET=51, RET=6 → 复杂 (15点)
```

#### 测试用例3：BigDecimal精度测试
```
测试场景：调整因子计算
VAF = 0.65 + 0.01 × 32 = 0.97
UFP = 129
AFP = 129 × 0.97 = 125.13

验证要求：
- 中间计算保持完整精度
- 最终结果精确到小数点后4位
- 使用HALF_UP舍入模式
```

#### 测试用例4：PDF指南案例验证
```
基于PDF指南第X页案例：
- 完全按照指南中的示例数据进行计算
- 验证每个步骤的中间结果
- 确认最终结果与指南完全一致
- 测试通过标准：100%准确匹配
```

## 📝 用户故事和验收条件

### 史诗(Epic): NESMA核心计算引擎
**作为**财政评审中心的工作人员  
**我希望**系统能够精确计算软件项目的NESMA功能点  
**以便**为政府投资信息化项目提供准确的规模评估

### 用户故事1：功能点识别和分类
**作为**评审专员  
**我希望**系统能够识别和分类5种NESMA功能点类型  
**以便**为后续计算提供准确的基础数据

**验收条件：**
- [ ] 系统能够正确识别ILF、EIF、EI、EO、EQ五种功能点类型
- [ ] 每种功能点类型的定义和识别标准完全符合PDF指南要求
- [ ] 支持用户手动输入和系统辅助识别两种方式
- [ ] 提供功能点类型识别的帮助文档和示例

### 用户故事2：复杂度等级判定
**作为**评审专员  
**我希望**系统能够自动判定每个功能点的复杂度等级  
**以便**确保计算结果的准确性

**验收条件：**
- [ ] 根据DET、RET、FTR数量自动判定复杂度等级
- [ ] 复杂度判定矩阵完全符合NESMA标准
- [ ] 边界条件判定100%准确
- [ ] 提供复杂度判定过程的详细说明

### 用户故事3：未调整功能点计算
**作为**评审专员  
**我希望**系统能够精确计算未调整功能点(UFP)  
**以便**获得项目的基础功能点数值

**验收条件：**
- [ ] UFP计算公式严格按照PDF指南执行
- [ ] 支持标准公式和详细计算两种模式
- [ ] 计算结果使用BigDecimal确保精度
- [ ] 提供计算过程的详细展示

### 用户故事4：调整因子应用
**作为**评审专员  
**我希望**系统能够应用技术复杂度调整因子  
**以便**获得更准确的调整功能点(AFP)

**验收条件：**
- [ ] 支持14个标准技术复杂度因子评分
- [ ] VAF计算公式严格按照标准执行
- [ ] 调整因子范围控制在0.65-1.35之间
- [ ] 提供调整因子详细说明和评分指导

### 用户故事5：复用度调整计算
**作为**评审专员  
**我希望**系统能够应用软件复用度调整  
**以便**反映实际开发工作量

**验收条件：**
- [ ] 支持高、中、低三个复用等级
- [ ] 复用调整系数分别为1/3、2/3、1
- [ ] 复用度评估提供标准化的评判标准
- [ ] 最终功能点计算结果精确到小数点后4位

### 用户故事6：计算结果验证和审计
**作为**系统管理员  
**我希望**所有计算过程都可以追溯和验证  
**以便**满足政府项目的审计要求

**验收条件：**
- [ ] 完整记录每次计算的输入参数和中间过程
- [ ] 支持计算结果的历史版本管理
- [ ] 提供计算过程的详细审计日志
- [ ] 支持计算结果与PDF指南案例的对比验证

## 🔬 质量保证要求

### 准确性要求
- **零偏差标准** - 所有计算结果与PDF指南案例必须100%一致
- **精度要求** - 数值计算误差不超过0.0001
- **边界测试** - 所有边界条件判定必须准确
- **异常处理** - 输入数据异常情况的妥善处理

### 性能要求  
- **计算响应时间** - 单次NESMA计算完成时间 < 2秒
- **并发处理** - 支持至少50个并发计算请求
- **数据处理** - 支持处理包含1000+功能点的大型项目
- **系统稳定性** - 连续运行24小时无内存泄漏

### 安全要求
- **数据完整性** - 计算过程中数据不被篡改
- **访问控制** - 只有授权用户才能执行计算
- **审计日志** - 完整记录所有计算操作
- **备份恢复** - 计算结果数据的安全备份

## 📅 开发里程碑

### 第一阶段：基础计算引擎 (完成度40%)
- [ ] 实现5种功能点类型的基础计算逻辑
- [ ] 完成复杂度判定算法
- [ ] 实现UFP基础计算

### 第二阶段：调整因子计算 (完成度70%)  
- [ ] 实现技术复杂度调整因子
- [ ] 完成AFP计算逻辑
- [ ] 添加复用度调整功能

### 第三阶段：验证和优化 (完成度100%)
- [ ] 完成PDF指南案例验证测试
- [ ] 性能优化和错误处理
- [ ] 完整的单元测试和集成测试

## 🎯 成功标准

本Sprint成功的衡量标准：
1. ✅ 所有5种功能点计算逻辑实现完成
2. ✅ 复杂度判定算法100%准确
3. ✅ BigDecimal数值计算精度达到要求
4. ✅ 核心算法单元测试覆盖率≥95%
5. ✅ PDF指南案例验证测试100%通过
6. ✅ 代码质量检查无Critical级别问题
7. ✅ 技术文档和API文档完整

---

**文档维护者：** Product Owner  
**审核状态：** 等待Developer Engineer确认  
**预计完成时间：** Sprint 1结束前  
**重要提醒：** 这是政府项目核心算法，所有实现都必须严格遵循PDF指南要求！