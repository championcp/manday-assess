# NESMA功能点评估系统 - 数据库表结构设计文档

## 📋 项目信息
- **项目名称：** NESMA功能点评估系统数据库设计
- **创建时间：** 2025-09-03
- **版本号：** V1.0
- **设计者：** Developer Engineer
- **数据库类型：** PostgreSQL
- **字符集：** UTF-8

## 🎯 设计目标

本数据库设计严格按照《长沙市财政评审中心政府投资信息化项目评审指南》的要求，为NESMA功能点评估系统提供完整的数据存储支撑，确保：

1. **准确性** - 支持精确的NESMA计算，确保与PDF指南案例100%一致
2. **可追溯性** - 完整记录评估过程，支持政府审计要求  
3. **安全性** - 多层次安全控制，符合政府信息化安全标准
4. **可扩展性** - 灵活的表结构设计，支持业务功能扩展

## 📊 数据库架构概览

### 核心模块划分

#### 1. 用户管理模块 (User Management)
- `users` - 用户基础信息表
- `roles` - 角色定义表  
- `permissions` - 权限定义表
- `role_permissions` - 角色权限关联表
- `user_roles` - 用户角色关联表

#### 2. 项目管理模块 (Project Management)  
- `projects` - 项目基础信息表
- `project_status_history` - 项目状态变更历史表
- `project_team_members` - 项目团队成员表
- `nesma_configurations` - NESMA评估配置表

#### 3. NESMA功能点模块 (Function Points)
- `function_points` - 功能点主表
- `function_point_elements` - 功能点数据元素表
- `function_point_relationships` - 功能点关系表
- `complexity_assessments` - 复杂度评估记录表  
- `function_point_history` - 功能点变更历史表

#### 4. NESMA详细信息模块 (Detailed Information)
- `ilf_details` - ILF（内部逻辑文件）详细信息表
- `eif_details` - EIF（外部接口文件）详细信息表
- `ei_details` - EI（外部输入）详细信息表
- `eo_details` - EO（外部输出）详细信息表  
- `eq_details` - EQ（外部查询）详细信息表

#### 5. 计算结果模块 (Calculation Results)
- `calculation_results` - NESMA计算结果主表
- `calculation_details` - 计算过程详情表
- `calculation_history` - 计算历史记录表
- `calculation_validations` - 计算验证表

#### 6. 审批流程模块 (Approval Workflow)
- `approval_workflow_templates` - 审批工作流模板表
- `approval_workflows` - 审批工作流实例表
- `approval_nodes` - 审批节点表
- `approval_records` - 审批记录表

#### 7. 审计监控模块 (Audit & Monitoring)
- `audit_logs` - 审计日志表
- `system_operation_logs` - 系统操作日志表
- `user_session_logs` - 用户会话日志表
- `security_event_logs` - 安全事件日志表
- `system_performance_metrics` - 系统性能监控表
- `system_error_logs` - 系统错误日志表
- `data_backup_records` - 数据备份记录表

## 📋 详细表结构说明

### 核心业务表

#### projects - 项目表
```sql
-- 支持政府投资信息化项目的完整生命周期管理
-- 包含项目编码、预算、技术平台、复杂度等级等关键信息
-- 集成NESMA计算结果汇总字段
```

#### function_points - 功能点主表  
```sql
-- NESMA五种功能点类型的统一管理
-- 支持复杂度等级、权重配置、版本控制
-- 与详细信息表形成一对一关系
```

#### calculation_results - 计算结果主表
```sql
-- 存储完整的NESMA计算过程和结果
-- 支持多版本计算、基线管理、审批流程
-- 包含成本估算和质量度量指标
```

### 关键设计特点

#### 1. 数据精度保证
- 所有金额和计算字段使用 `DECIMAL(19,4)` 确保精度
- 时间字段统一使用 `TIMESTAMP WITH TIME ZONE`
- 支持BigDecimal级别的数值计算

#### 2. 审计追溯机制
- 所有业务表包含完整的审计字段（创建时间、修改时间、创建人、修改人）
- 支持软删除机制（deleted_at字段）  
- 自动触发器记录重要数据变更历史

#### 3. 安全控制体系
- 基于RBAC的权限控制模型
- 多层次的数据访问控制
- 完整的安全事件日志记录

#### 4. 性能优化设计
- 为查询热点字段创建索引
- 支持数据分区（审计日志按月分区）
- 优化的查询视图和统计视图

## 🔗 关键业务关系

### 核心实体关系图
```
项目(Projects) 
    ↓ 1:N
功能点(Function Points)
    ↓ 1:1  
功能点详情(ILF/EIF/EI/EO/EQ Details)
    ↓ N:1
计算结果(Calculation Results)
    ↓ 1:N
审批流程(Approval Workflows)
```

### 重要外键关系
- **用户关联** - 所有业务表都关联到用户表，支持数据权限控制
- **项目关联** - 功能点、计算结果等核心数据都关联到项目  
- **版本关联** - 支持计算结果的版本管理和历史追溯
- **审批关联** - 重要业务变更都可以触发审批流程

## 📈 数据规模预估

### 预期数据量（年处理能力）
- **项目数量：** 200-500个政府信息化项目
- **功能点数量：** 10,000-50,000个NESMA功能点
- **计算记录：** 1,000-2,000次计算执行
- **审计日志：** 100万-500万条操作记录
- **用户会话：** 50万-100万次登录记录

### 存储空间估算
- **业务数据：** 5-10GB/年
- **审计日志：** 20-50GB/年  
- **性能监控：** 5-10GB/年
- **备份存储：** 建议保留3年数据

## 🛡️ 安全设计

### 数据安全措施
1. **敏感字段加密** - 用户密码使用BCrypt加密
2. **访问权限控制** - 基于角色的细粒度权限管理
3. **操作审计** - 完整记录所有业务操作  
4. **会话管理** - 支持会话超时、并发控制
5. **数据备份** - 自动化备份策略和恢复验证

### 合规性保证
- 符合《等保三级》安全标准要求
- 满足政府信息化项目审计要求
- 支持数据溯源和审计查询

## 🔧 维护和优化

### 自动化维护
- **日志清理** - 自动清理过期日志数据
- **数据备份** - 定时备份和验证
- **性能监控** - 实时监控数据库性能指标
- **索引优化** - 定期分析和优化索引

### 扩展性设计  
- **水平扩展** - 支持读写分离和分库分表
- **版本升级** - Flyway管理数据库版本
- **配置灵活** - 重要参数支持配置化管理

## 📋 部署检查清单

### 部署前验证
- [ ] 所有迁移脚本执行成功
- [ ] 核心表结构验证通过
- [ ] 外键关系检查正确
- [ ] 索引创建完成
- [ ] 默认配置数据初始化
- [ ] 触发器和函数工作正常

### 性能测试
- [ ] 数据库连接池配置
- [ ] 查询性能基准测试
- [ ] 并发访问压力测试  
- [ ] 大数据量处理测试

### 安全检查
- [ ] 默认账户密码修改
- [ ] 数据库访问权限配置
- [ ] 审计日志记录测试
- [ ] 备份恢复流程测试

## 🎯 下阶段规划

### Sprint 2 准备工作
1. **Entity类设计** - 基于表结构创建JPA实体类
2. **Repository层实现** - 实现数据访问层
3. **Service层业务逻辑** - 实现NESMA计算引擎
4. **API接口设计** - 提供REST API支持前端

### 性能优化计划
1. **查询优化** - 基于实际使用模式优化查询
2. **缓存策略** - Redis缓存热点数据
3. **分库分表** - 支持大规模数据处理
4. **监控告警** - 完善性能监控体系

---

**文档维护：** Developer Engineer  
**最后更新：** 2025-09-03  
**审核状态：** 待Product Owner确认

**重要提醒：这是政府项目核心数据架构，所有变更都需要经过严格审核！**